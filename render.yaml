# =============================================================================
# RENDER.COM DEPLOYMENT CONFIGURATION
# =============================================================================
# 
# Deployment: Backend (Web Service) + Frontend (Static Site) + PostgreSQL
#
# ВАЖНО: После первого деплоя:
#   1. Backend получит URL вида: https://marsdevs-api.onrender.com
#   2. Frontend получит URL вида: https://marsdevs-frontend.onrender.com
#   3. Обновите VITE_API_URL для frontend в Render Dashboard:
#      Environment -> VITE_API_URL = https://marsdevs-api.onrender.com/api
#
# Usage:
#   1. Push to GitHub
#   2. Connect repo to Render (Blueprint)
#   3. Render auto-deploys using this config
#   4. После деплоя - создайте admin: /setup-admin/?key=marsdevs-setup-2024
#
# =============================================================================

services:
  # ===========================================================================
  # Backend API (Django)
  # ===========================================================================
  - type: web
    name: marsdevs-api
    runtime: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    region: frankfurt  # Change to your preferred region
    plan: free  # or starter, standard, etc.
    healthCheckPath: /health/
    envVars:
      # Django settings
      - key: DEBUG
        value: "False"
      - key: SECRET_KEY
        generateValue: true
      - key: ALLOWED_HOSTS
        value: ".onrender.com,localhost"
      - key: USE_SQLITE
        value: "False"
      
      # Database (auto-linked from databases section)
      - key: DATABASE_URL
        fromDatabase:
          name: marsdevs-db
          property: connectionString
      
      # CORS - разрешает frontend домен
      # Автоматически также разрешены все *.onrender.com через regex в settings.py
      - key: CORS_ALLOWED_ORIGINS
        value: "https://marsdevs-frontend.onrender.com"
      - key: CSRF_TRUSTED_ORIGINS
        value: "https://marsdevs-frontend.onrender.com,https://marsdevs-api.onrender.com"
      
      # JWT
      - key: JWT_ACCESS_TOKEN_LIFETIME_MINUTES
        value: "60"
      - key: JWT_REFRESH_TOKEN_LIFETIME_DAYS
        value: "7"
      
      # Admin setup key (change in production!)
      - key: SETUP_KEY
        value: "marsdevs-setup-2024"

  # ===========================================================================
  # Frontend (React Static Site)
  # ===========================================================================
  - type: web
    name: marsdevs-frontend
    runtime: static
    buildCommand: cd frontend && npm ci && npm run build
    staticPublishPath: frontend/dist
    pullRequestPreviewsEnabled: true
    # Environment variables для build
    envVars:
      # ВАЖНО: /api в конце! Эта переменная используется при сборке Vite
      # После деплоя backend - замените marsdevs-api на ваш реальный URL
      - key: VITE_API_URL
        value: "https://marsdevs-api.onrender.com/api"
    headers:
      - path: /*
        name: X-Frame-Options
        value: SAMEORIGIN
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
    routes:
      # API proxy to backend (fallback если VITE_API_URL = /api)
      - type: rewrite
        source: /api/*
        destination: https://marsdevs-api.onrender.com/api/*
      # Media files proxy
      - type: rewrite
        source: /media/*
        destination: https://marsdevs-api.onrender.com/media/*
      # Static files proxy (Django admin)
      - type: rewrite
        source: /static/*
        destination: https://marsdevs-api.onrender.com/static/*
      # Admin proxy
      - type: rewrite
        source: /admin/*
        destination: https://marsdevs-api.onrender.com/admin/*
      # SPA fallback - все остальные пути -> index.html
      - type: rewrite
        source: /*
        destination: /index.html

# =============================================================================
# Database
# =============================================================================
databases:
  - name: marsdevs-db
    plan: free  # or starter, standard, etc.
    databaseName: marsdevs_db
    user: marsdevs
    region: frankfurt  # Same as backend
